<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CARSWAG - Panel Administracyjny</title>
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Security headers -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Referrer-Policy" content="no-referrer">
    
    <script src="https://resource.trickle.so/vendor_lib/unpkg/react@18/umd/react.production.min.js"></script>
    <script src="https://resource.trickle.so/vendor_lib/unpkg/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://resource.trickle.so/vendor_lib/unpkg/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- GSAP Animation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    
    <link href="https://resource.trickle.so/vendor_lib/unpkg/lucide-static@0.516.0/font/lucide.css" rel="stylesheet">
    
    <style>
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Custom scrollbar styles */
        .scrollbar-thin {
            scrollbar-width: thin;
        }
        
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-track {
            background: rgba(55, 65, 81, 0.3);
            border-radius: 3px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: rgba(107, 114, 128, 0.8);
            border-radius: 3px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: rgba(107, 114, 128, 1);
        }
    </style>
    
    <!-- Import utilities and components -->
    <script type="text/javascript" src="utils/cookies.js"></script>
    <script src="utils/animations.js"></script>
    <script type="text/babel" src="utils/supabase.js"></script>
    <script type="text/babel" src="components/KaczkaPanel.js"></script>

    <style type="text/tailwindcss">
    @layer theme {
        :root {
            --primary: #dc2626;
            --secondary: #1f2937;
            --accent: #f59e0b;
        }
    }

    @layer base {
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            min-height: 100vh;
        }
    }

    @layer components {
        .btn-primary {
            @apply bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors;
        }
        .btn-secondary {
            @apply bg-gray-700 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors;
        }
        .card {
            @apply bg-white/10 backdrop-blur-sm border border-white/20 rounded-xl p-6;
        }
        .input-field {
            @apply w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-red-500;
        }
    }
    </style>
</head>
<body>
    <div id="kaczka-root"></div>

    <!-- Secure Supabase Client - Only for Admin Panel -->
    <script type="text/babel">
        class KaczkaSupabaseClient {
            constructor() {
                // Secure Supabase configuration - only in kaczka panel
                this.supabaseUrl = 'https://bncsuwksjdxfjzeqyqud.supabase.co';
                this.supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJuY3N1d2tzamR4Zmp6ZXF5cXVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4MjQ5NTksImV4cCI6MjA2ODQwMDk1OX0.avePl5wWJy9vnsqvZ3sYzh3D_xM9BSJgbDOG8QBg_5c';
                this.apiUrl = '/api/proxy.js';
            }

            async query(table, options = {}) {
                const response = await fetch(this.apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'select',
                        table,
                        ...options
                    })
                });
                
                if (!response.ok) throw new Error('Query failed');
                return await response.json();
            }

            async update(table, data, where) {
                const response = await fetch(this.apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'update',
                        table,
                        data,
                        where
                    })
                });
                
                if (!response.ok) throw new Error('Update failed');
                return await response.json();
            }

            async getAppSettings() {
                try {
                    const settings = await this.query('app_settings');
                    return settings[0] || {};
                } catch (error) {
                    console.error('Get app settings error:', error);
                    return {};
                }
            }

            async updateAppSettings(data) {
                return await this.update('app_settings', data, { id: 1 });
            }
        }

        const kaczkaSupabase = new KaczkaSupabaseClient();

        function KaczkaLogin({ onLogin }) {
            const [name, setName] = React.useState('');
            const [email, setEmail] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            const [error, setError] = React.useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');

                try {
                    // Find user with admin role using name and email
                    const kaczkaUsers = await kaczkaSupabase.query('users', {
                        select: '*',
                        eq: { name: name, email: email, role: 'admin' }
                    });

                    if (kaczkaUsers.length > 0) {
                        const validKaczka = kaczkaUsers[0];
                        setCookie('kaczkaAuth', 'true', 30);
                        saveUserSession(validKaczka);
                        onLogin(validKaczka);
                    } else {
                        setError('Nieprawidłowe dane logowania lub brak uprawnień kaczki');
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    setError('Błąd podczas logowania');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="bg-white/10 backdrop-blur-sm border border-white/20 rounded-xl p-8 w-full max-w-md">
                        <div className="text-center mb-8">
                            <h1 className="text-3xl font-bold text-white mb-2">Panel Kaczki</h1>
                            <p className="text-gray-300">Dostęp tylko dla kaczek</p>
                        </div>

                        {error && (
                            <div className="bg-red-500/20 border border-red-500/50 rounded-lg p-3 mb-4">
                                <p className="text-red-300 text-sm">{error}</p>
                            </div>
                        )}

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-300 mb-2">
                                    Nazwa użytkownika
                                </label>
                                <input
                                    type="text"
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    className="input-field"
                                    placeholder="Wprowadź nazwę"
                                    required
                                />
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium text-gray-300 mb-2">
                                    Email
                                </label>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="input-field"
                                    placeholder="Wprowadź email"
                                    required
                                />
                            </div>

                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full btn-primary disabled:opacity-50"
                            >
                                {loading ? 'Logowanie...' : 'Zaloguj jako Kaczka'}
                            </button>
                        </form>

                        <div className="mt-6 text-center">
                            <a href="/" className="text-blue-400 hover:text-blue-300 text-sm">
                                ← Powrót do aplikacji głównej
                            </a>
                        </div>
                    </div>
                </div>
            );
        }

        function KaczkaApp() {
            const [user, setUser] = React.useState(null);
            const [loading, setLoading] = React.useState(true);

            React.useEffect(() => {
                loadKaczkaUser();
            }, []);

            const loadKaczkaUser = async () => {
                try {
                    // Check if already authenticated
                    const isAuth = getCookie('kaczkaAuth');
                    if (isAuth === 'true') {
                        // Try to get user from session first
                        const sessionUser = getUserSession();
                        if (sessionUser && sessionUser.role === 'admin') {
                            setUser(sessionUser);
                            return;
                        }
                        
                        // If no valid session, clear auth
                        deleteCookie('kaczkaAuth');
                        clearUserSession();
                    }
                } catch (error) {
                    console.error('Load kaczka user error:', error);
                    deleteCookie('kaczkaAuth');
                    clearUserSession();
                } finally {
                    setLoading(false);
                }
            };

            const handleLogin = (userData) => {
                setUser(userData);
            };

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="text-white">Ładowanie...</div>
                    </div>
                );
            }

            if (!user) {
                return <KaczkaLogin onLogin={handleLogin} />;
            }

            return <KaczkaPanel user={user} />;
        }

        const kaczkaRoot = ReactDOM.createRoot(document.getElementById('kaczka-root'));
        kaczkaRoot.render(<KaczkaApp />);
    </script>
</body>
</html>